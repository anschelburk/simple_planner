{% extends "base_site.html" %}

{% block head_content %}
    {% load static %}
    <meta charset="UTF-8">
    <script src="https://unpkg.com/htmx.org@1.4.1"></script>
    <link href="{% static 'css/styling.css' %}" rel="stylesheet">
    <style>
        .list-container {
            display: flex;
            justify-content: space-between;
        }
        .list {
            width: 45%;
        }
    </style>
    <script>
        document.addEventListener('htmx:configRequest', function(event) {
            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            event.detail.headers['X-CSRFToken'] = csrfToken;
        });

        document.addEventListener('htmx:configRequest', function(event) {
            if (event.detail.triggeringEvent.type === 'keydown' && event.detail.triggeringEvent.key === 'Enter') {
                var listId = event.detail.triggeringEvent.target.closest('form').querySelector('[name="list_id"]').value;
                event.detail.path = `/list/${listId}/add_item/`;
                event.detail.headers['HX-Trigger'] = 'add-new-item';
            }
        });

        document.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.xhr && event.detail.xhr.responseURL.includes("/add_item/")) {
                var listId = event.detail.triggeringEvent.target.closest('form').querySelector('[name="list_id"]').value;
                const form = document.querySelector(`#add-item-form-${listId}`);
                form.reset();  // Clear the form for the next input
                form.querySelector('input[type="text"]').focus();  // Focus on the input field

                console.log('Item added');

            }
        });

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                event.target.blur();
            }
        }
    </script>
{% endblock %}

{% block body_content %}
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="list-container">
        <div class="list">
            <h1>List 1</h1>
            <ul id="item-list-1">
                {% for item in list1_items %}
                    <li id="item-{{ item.pk }}" hx-get="{% url 'list_update_item' 1 item.pk %}" hx-trigger="click">
                        {{ item.content }}
                    </li>
                {% endfor %}
            </ul>
            <form id="add-item-form-1" hx-post="{% url 'list_add_item' 1 %}" hx-target="#item-list-1" hx-swap="beforeend" hx-on="htmx:afterOnLoad: this.reset()">
                {% csrf_token %}
                {{ add_form1.as_p }}
                <input type="submit" value="Add">
            </form>
        </div>
        <div class="list">
            <h1>List 2</h1>
            <ul id="item-list-2">
                {% for item in list2_items %}
                    <li id="item-{{ item.pk }}" hx-get="{% url 'list_update_item' 2 item.pk %}" hx-trigger="click">
                        {{ item.content }}
                    </li>
                {% endfor %}
            </ul>
            <form id="add-item-form-2" hx-post="{% url 'list_add_item' 2 %}" hx-target="#item-list-2" hx-swap="beforeend" hx-on="htmx:afterOnLoad: this.reset()">
                {% csrf_token %}
                {{ add_form2.as_p }}
                <input type="submit" value="Add">
            </form>
        </div>
    </div>
{% endblock %}
